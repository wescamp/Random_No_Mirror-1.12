#textdomain wesnoth-Random_No_Mirror

#define RT_NERF_LEADERSHIP_UNITS
    [store_unit]
        [filter]
            canrecruit=yes
        [/filter]
        variable=Random_Traits_all_leaders
    [/store_unit]

    {FOREACH Random_Traits_all_leaders i}
        {FOREACH Random_Traits_all_leaders[$i].abilities j}
            {FOREACH Random_Traits_all_leaders[$i].modifications.trait k}
                {IF_VAR Random_Traits_all_leaders[$i].modifications.trait[$k].id equals aged (
                    [then]
                        {VARIABLE leadership_already_nerfed yes}
                    [/then]
                )}
            {NEXT k}
            [if]
                {VARIABLE_CONDITIONAL Random_Traits_all_leaders[$i].abilities[$j].leadership.id not_equals $null}
                {VARIABLE_CONDITIONAL leadership_already_nerfed not_equals yes}
                [then]
                    [set_variables]
                        name=RT_temp
                        [literal]
                            {TRAIT_AGED}
                        [/literal]
                    [/set_variables]
                    [set_variables]
                        name=Random_Traits_all_leaders[$i].modifications.trait
                        mode=append
                        [insert_tag]
                            name=literal
                            variable=RT_temp.trait
                        [/insert_tag]
                    [/set_variables]
                    {CLEAR_VARIABLE Random_Traits_all_leaders[$i].max_moves,Random_Traits_all_leaders[$i].moves,Random_Traits_all_leaders[$i].max_hitpoints,Random_Traits_all_leaders[$i].hitpoints}
                    {FOREACH Random_Traits_all_leaders[$i].attack k}
                        {IF_VAR Random_Traits_all_leaders[$i].attack[$k].range equals melee (
                            [then]
                                {VARIABLE_OP Random_Traits_all_leaders[$i].attack[$k].damage sub 1}
                            [/then]
                        )}
                    {NEXT k}
                    [unstore_unit]
                        variable=Random_Traits_all_leaders[$i]
                        find_vacant=no
                    [/unstore_unit]
                [/then]
            [/if]
        {NEXT j}
    {NEXT i}
    {CLEAR_VARIABLE Random_Traits_all_leaders,RT_temp,leadership_already_nerfed}
#enddef

#define RT_NERF_HEALING_UNITS
    [store_unit]
        [filter]
            canrecruit=yes
        [/filter]
        variable=Random_Traits_all_leaders
    [/store_unit]

    {FOREACH Random_Traits_all_leaders i}
        {VARIABLE healing_already_nerfed no}

        {FOREACH Random_Traits_all_leaders[$i].abilities j}
            {FOREACH Random_Traits_all_leaders[$i].modifications.trait k}
                {IF_VAR Random_Traits_all_leaders[$i].modifications.trait[$k].id equals dim (
                    [then]
                        {VARIABLE healing_already_nerfed yes}
                    [/then]
                )}
            {NEXT k}

            [if]
                [and]
                    [variable]
                        name=Random_Traits_all_leaders[$i].abilities[$j].heals.id
                        not_equals=$null
                    [/variable]
                    [variable]
                        name=healing_already_nerfed
                        not_equals=yes
                    [/variable]
                [/and]
                [then]
                    [set_variables]
                        name=RT_temp
                        [literal]
                            {TRAIT_DIM}
                        [/literal]
                    [/set_variables]
                    [set_variables]
                        name=Random_Traits_all_leaders[$i].modifications.trait
                        mode=append
                        [insert_tag]
                            name=literal
                            variable=RT_temp.trait
                        [/insert_tag]
                    [/set_variables]
                    {CLEAR_VARIABLE Random_Traits_all_leaders[$i].max_experience}
                    [unstore_unit]
                        variable=Random_Traits_all_leaders[$i]
                        find_vacant=no
                    [/unstore_unit]
                [/then]
            [/if]
        {NEXT j}
    {NEXT i}
    {CLEAR_VARIABLE Random_Traits_all_leaders,RT_temp,healing_already_nerfed}
#enddef

#define RT_NERF_UNITS_WITH_SPECIAL_ABILITIES
    [store_unit]
        [filter]
            canrecruit=yes
        [/filter]
        variable=Random_Traits_all_leaders
    [/store_unit]

    {FOREACH Random_Traits_all_leaders i}
        ## set variable
        {VARIABLE special_already_nerfed no}
        {VARIABLE special_nerf_unit no}

        {FOREACH Random_Traits_all_leaders[$i].modifications.trait k}
            {IF_VAR Random_Traits_all_leaders[$i].modifications.trait[$k].id equals weak (
                [then]
                    {VARIABLE special_already_nerfed yes}
                [/then]
            )}
        {NEXT k}

        {FOREACH Random_Traits_all_leaders[$i].abilities j}
            [if]
                [variable]
                    name=Random_Traits_all_leaders[$i].abilities[$j].illuminates.id
                    not_equals=$null
                [/variable]
                [or]
                    [variable]
                        name=Random_Traits_all_leaders[$i].abilities[$j].skirmisher.id
                        not_equals=$null
                    [/variable]
                [/or]
                [or]
                    [variable]
                        name=Random_Traits_all_leaders[$i].abilities[$j].resistance.id
                        not_equals=$null
                    [/variable]
                [/or]
                [then]
                    {VARIABLE special_nerf_unit yes}
                [/then]
            [/if]
        {NEXT j}

        {FOREACH Random_Traits_all_leaders[$i].attack k}
            {FOREACH Random_Traits_all_leaders[$i].attack[$k].specials l}
                [if]
                    [variable]
                        name=Random_Traits_all_leaders[$i].attack[$k].specials[$l].damage.id
                        not_equals=$null
                    [/variable]
                    [or]
                        [variable]
                            name=Random_Traits_all_leaders[$i].attack[$k].specials[$l].firststrike.id
                            not_equals=$null
                        [/variable]
                    [/or]
                    [or]
                        [variable]
                            name=Random_Traits_all_leaders[$i].attack[$k].specials[$l].chance_to_hit.id
                            not_equals=$null
                        [/variable]
                    [/or]
                    [then]
                        {VARIABLE special_nerf_unit yes}
                    [/then]
                [/if]
            {NEXT l}
        {NEXT k}

        [if]
            {VARIABLE_CONDITIONAL special_already_nerfed not_equals yes}
            {VARIABLE_CONDITIONAL special_nerf_unit equals yes}
            [then]
                [set_variables]
                    name=RT_temp
                    [literal]
                        {TRAIT_WEAK}
                    [/literal]
                [/set_variables]
                [set_variables]
                    name=Random_Traits_all_leaders[$i].modifications.trait
                    mode=append
                    [insert_tag]
                        name=literal
                        variable=RT_temp.trait
                    [/insert_tag]
                [/set_variables]
                {CLEAR_VARIABLE Random_Traits_all_leaders[$i].max_hitpoints,Random_Traits_all_leaders[$i].hitpoints}
                {FOREACH Random_Traits_all_leaders[$i].attack m}
                    {IF_VAR Random_Traits_all_leaders[$i].attack[$m].range equals melee (
                        [then]
                            {VARIABLE_OP Random_Traits_all_leaders[$i].attack[$m].damage sub 1}
                        [/then]
                    )}
                {NEXT m}
                [unstore_unit]
                    variable=Random_Traits_all_leaders[$i]
                    find_vacant=no
                [/unstore_unit]
            [/then]
        [/if]
    {NEXT i}
    {CLEAR_VARIABLE Random_Traits_all_leaders,RT_temp,special_nerf_unit,special_already_nerfed}
#enddef

#define RT_RANDOM_LEADER_TRAITS
    [store_unit]
        [filter]
            canrecruit=yes
        [/filter]
        variable=Random_Traits_all_leaders
    [/store_unit]

    {FOREACH Random_Traits_all_leaders i}
        {IF_VAR Random_Traits_all_leaders[$i].type contains Wose (
            [then]
                [set_variables]
                    name=RT_temp
                    [literal]
                        {TRAIT_FEARLESS}
                    [/literal]
                [/set_variables]
                [set_variables]
                    name=Random_Traits_all_leaders[$i].modifications.trait
                    mode=append
                    [insert_tag]
                        name=literal
                        variable=RT_temp.trait
                    [/insert_tag]
                [/set_variables]
                [unstore_unit]
                    variable=Random_Traits_all_leaders[$i]
                    find_vacant=no
                [/unstore_unit]
            [/then]
            [else]
                {FOREACH Random_Traits_all_leaders[$i].attack x}
                    {IF_VAR Random_Traits_all_leaders[$i].attack[$x].range equals ranged (
                        [then]
                            {VARIABLE have_ranged yes}
                        [/then]
                    )}
                {NEXT x}

                [while]
                    [variable]
                        name=Random_Traits_all_leaders[$i].modifications.trait.length
                        less_than=2
                    [/variable]
                    [do]
                        {VARIABLE_OP random_traits rand(strong,resilient,healthy,dextrous,intelligent)}
                        [while]
                            [variable]
                                name=random_traits
                                equals=$Random_Traits_all_leaders[$i].modifications.trait[0].id
                            [/variable]
                            [or]
                                [and]
                                    [variable]
                                        name=random_traits
                                        equals=strong
                                    [/variable]
                                    [variable]
                                        name=Random_Traits_all_leaders[$i].modifications.trait[0].id
                                        equals=weak
                                    [/variable]
                                [/and]
                            [/or]
                            [or]
                                [and]
                                    [variable]
                                        name=random_traits
                                        equals=intelligent
                                    [/variable]
                                    [variable]
                                        name=Random_Traits_all_leaders[$i].modifications.trait[0].id
                                        equals=dim
                                    [/variable]
                                [/and]
                            [/or]
                            [or]
                                [and]
                                    [variable]
                                        name=random_traits
                                        equals=dextrous
                                    [/variable]
                                    [variable]
                                        name=have_ranged
                                        not_equals=yes
                                    [/variable]
                                [/and]
                            [/or]
                            [or]
                                [and]
                                    [variable]
                                        name=random_traits
                                        equals=intelligent
                                    [/variable]
                                    [variable]
                                        name=Random_Traits_all_leaders[$i].type
                                        contains=Troll
                                    [/variable]
                                [/and]
                            [/or]
                            [do]
                                {VARIABLE_OP random_traits rand(strong,resilient,healthy,dextrous,intelligent)}
                            [/do]
                        [/while]

                        [switch]
                            variable=random_traits
                            [case]
                                value=strong
                                [set_variables]
                                    name=RT_temp
                                    [literal]
                                        {TRAIT_STRONG}
                                    [/literal]
                                [/set_variables]
                                [set_variables]
                                    name=Random_Traits_all_leaders[$i].modifications.trait
                                    mode=append
                                    [insert_tag]
                                        name=literal
                                        variable=RT_temp.trait
                                    [/insert_tag]
                                [/set_variables]
                                {CLEAR_VARIABLE Random_Traits_all_leaders[$i].hitpoints,Random_Traits_all_leaders[$i].max_hitpoints}
                                {FOREACH Random_Traits_all_leaders[$i].attack j}
                                    {IF_VAR Random_Traits_all_leaders[$i].attack[$j].range equals melee (
                                        [then]
                                            {VARIABLE_OP Random_Traits_all_leaders[$i].attack[$j].damage add 1}
                                        [/then]
                                    )}
                                {NEXT j}
                            [/case]
                            [case]
                                value=resilient
                                [set_variables]
                                    name=RT_temp
                                    [literal]
                                        {TRAIT_RESILIENT}
                                    [/literal]
                                [/set_variables]
                                [set_variables]
                                    name=Random_Traits_all_leaders[$i].modifications.trait
                                    mode=append
                                    [insert_tag]
                                        name=literal
                                        variable=RT_temp.trait
                                    [/insert_tag]
                                [/set_variables]
                                {CLEAR_VARIABLE Random_Traits_all_leaders[$i].hitpoints,Random_Traits_all_leaders[$i].max_hitpoints}
                            [/case]
                            [case]
                                value=healthy
                                [set_variables]
                                    name=RT_temp
                                    [literal]
                                        {TRAIT_HEALTHY}
                                    [/literal]
                                [/set_variables]
                                [set_variables]
                                    name=Random_Traits_all_leaders[$i].modifications.trait
                                    mode=append
                                    [insert_tag]
                                        name=literal
                                        variable=RT_temp.trait
                                    [/insert_tag]
                                [/set_variables]
                                {CLEAR_VARIABLE Random_Traits_all_leaders[$i].hitpoints,Random_Traits_all_leaders[$i].max_hitpoints}
                            [/case]
                            [case]
                                value=dextrous
                                [set_variables]
                                    name=RT_temp
                                    [literal]
                                        {TRAIT_DEXTROUS}
                                    [/literal]
                                [/set_variables]
                                [set_variables]
                                    name=Random_Traits_all_leaders[$i].modifications.trait
                                    mode=append
                                    [insert_tag]
                                        name=literal
                                        variable=RT_temp.trait
                                    [/insert_tag]
                                [/set_variables]
                                {FOREACH Random_Traits_all_leaders[$i].attack j}
                                    {IF_VAR Random_Traits_all_leaders[$i].attack[$j].range equals ranged (
                                        [then]
                                            {VARIABLE_OP Random_Traits_all_leaders[$i].attack[$j].damage add 1}
                                        [/then]
                                    )}
                                {NEXT j}
                            [/case]
                            [case]
                                value=intelligent
                                [set_variables]
                                    name=RT_temp
                                    [literal]
                                        {TRAIT_INTELLIGENT}
                                    [/literal]
                                [/set_variables]
                                [set_variables]
                                    name=Random_Traits_all_leaders[$i].modifications.trait
                                    mode=append
                                    [insert_tag]
                                        name=literal
                                        variable=RT_temp.trait
                                    [/insert_tag]
                                [/set_variables]
                                {CLEAR_VARIABLE Random_Traits_all_leaders[$i].max_experience}
                            [/case]
                        [/switch]
                    [/do]
                [/while]
                [unstore_unit]
                    variable=Random_Traits_all_leaders[$i]
                    find_vacant=no
                [/unstore_unit]
                {CLEAR_VARIABLE have_ranged,random_traits}
            [/else]
        )}
    {NEXT i}
    {CLEAR_VARIABLE Random_Traits_all_leaders,RT_temp}
#enddef

#define RT_SLOW_QUICK_LEADERS
    [event]
        name=prestart

        [store_unit]
            [filter]
                canrecruit=yes
            [/filter]
            variable=Random_Traits_all_leaders
        [/store_unit]

        {FOREACH Random_Traits_all_leaders i}
            [if]
                {VARIABLE_CONDITIONAL Random_Traits_all_leaders[$i].max_moves greater_than 6}
                {VARIABLE_CONDITIONAL Random_Traits_all_leaders[$i].variables.dont_make_me_slow boolean_not_equals yes}
                [then]
                    [set_variables]
                        name=RT_temp
                        [literal]
                            {TRAIT_SLOW}
                        [/literal]
                    [/set_variables]
                    [set_variables]
                        name=Random_Traits_all_leaders[$i].modifications.trait
                        mode=append
                        [insert_tag]
                            name=literal
                            variable=RT_temp.trait
                        [/insert_tag]
                    [/set_variables]
                    {CLEAR_VARIABLE Random_Traits_all_leaders[$i].max_moves,Random_Traits_all_leaders[$i].moves,Random_Traits_all_leaders[$i].max_hitpoints,Random_Traits_all_leaders[$i].hitpoints}
                    [unstore_unit]
                        variable=Random_Traits_all_leaders[$i]
                        find_vacant=no
                    [/unstore_unit]
                [/then]
            [/if]
        {NEXT i}
        {CLEAR_VARIABLE Random_Traits_all_leaders,RT_temp}
    [/event]
#enddef
